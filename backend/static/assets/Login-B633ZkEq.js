import{o as D,p as A,f as S,a as v,r as N,j as e,A as G,q as B,t as U,B as j}from"./index-Bl3f9Dxg.js";import{a as I,c as F,A as L}from"./AppInput-CZB3jFkU.js";import{u as P}from"./index.esm-BmxENRqK.js";import{L as C}from"./post-D6em6Wc_.js";import{A as x}from"./AppPassword-DryXLLea.js";import{A as R,D as k}from"./index-Ch_N3k7V.js";import"./index-Iy0nxoBl.js";import"./TextArea-DyQsbb_N.js";import"./SearchOutlined-BOVmvXrh.js";const M=({setLoading:r,setIsFirstLogin:c,setFirstLoginData:t})=>{const m=D(),l=A(),{messageApi:a}=S(),p=P({mode:"onChange",resolver:I(F),defaultValues:{email:"",password:"",current_password:"",new_password:"",confirm_password:""}}),{handleSubmit:d,getValues:w}=p,b=o=>{console.log("DEBUG: Form submitted with data:",o),r(!0),o.current_password&&o.new_password&&o.confirm_password?(console.log("DEBUG: Handling first login submission"),u(o)):(console.log("DEBUG: Handling normal login submission"),i(o))},i=o=>{console.log("DEBUG: Starting normal login with data:",o);const n={username:o?.email,password:o?.password};console.log("DEBUG: Sending login request with:",n),C(n).then(s=>{if(console.log("DEBUG: Login response:",s),s?.data?.is_first_login){const h=s?.data?.user?.role||"AGENT";console.log("DEBUG: First login detected - userRole:",h),console.log("DEBUG: Full response data for first login:",s?.data);const E=h==="ADMIN"?"Please set your new password to continue as Admin.":"Please set your new password to continue.";localStorage.setItem("temp_first_login_role",h),console.log("DEBUG: Stored role in localStorage:",h),a.info(E),c?.(!0),t?.({email:s?.data?.email,password:o?.password}),r(!1);return}console.log("DEBUG: User role from response:",s?.data?.user?.role),console.log("DEBUG: Full response data:",s?.data),s?.data?.user?.role=="SUPERADMIN"?(console.log("DEBUG: Navigating to super-admin dashboard"),l("/super-admin/dashboard")):s?.data?.user?.role=="ADMIN"?(console.log("DEBUG: Navigating to admin dashboard"),l("/app/dashboard")):s?.data?.user?.role=="AGENT"?(console.log("DEBUG: Navigating to agent dashboard"),l("/agent/dashboard")):(console.log("DEBUG: Default navigation to agent dashboard"),l("/agent/dashboard"));const g=s?.data?.user?.role||"AGENT",f=s?.data?.user?.id||s?.data?.agent?.id,_=s?.data?.user?.company_id||s?.data?.agent?.company_id||"DEFAULT_COMPANY";localStorage.setItem("access_token",s?.data?.access),localStorage.setItem("adminId",f),localStorage.setItem("company_id",_),localStorage.setItem("role",g),localStorage.setItem("isAuth","true"),m?.setIsAuth("true"),m?.setRole(g),r(!1),a.success("Login Successfully")}).catch(s=>{console.log("DEBUG: Login error:",s),console.log("DEBUG: Error response:",s?.response),console.log("DEBUG: Error data:",s?.response?.data),r(!1),s?.response?.data?.error?a.error(s.response.data.error):s?.response?.data?.non_field_errors?.[0]?a.error(s.response.data.non_field_errors[0]):s?.response?.data?.detail?a.error(s.response.data.detail):s?.message?a.error(s.message):a.error("Login failed. Please try again.")})},u=async o=>{console.log("DEBUG: Starting first login submit with data:",o);try{if(o.new_password!==o.confirm_password){console.log("DEBUG: Passwords don't match"),a.error("New passwords do not match"),r(!1);return}const n=w();console.log("DEBUG: First login data from form:",n);const s=localStorage.getItem("temp_first_login_role"),g=s==="ADMIN";console.log("DEBUG: Retrieved stored role:",s),console.log("DEBUG: Is admin first login:",g);const f=g?"/auth/admin-first-login/":"/admin-dashboard/agent-first-login/";console.log("DEBUG: Using endpoint:",f,"for role:",s),await v.post(f,{email:n.email,current_password:o.current_password,new_password:o.new_password,confirm_password:o.confirm_password}),a.success("Password updated successfully! Please login with your new password."),localStorage.removeItem("temp_first_login_role"),c?.(!1),t?.(null),p.reset({email:n.email,password:"",current_password:"",new_password:"",confirm_password:""})}catch(n){a.error(n?.response?.data?.error||"Failed to update password")}finally{r(!1)}},y=()=>{c?.(!0)};return{formHooks:p,formSubmit:d(b),handleFirstLogin:y}};function J(){const[r,c]=N.useState(!1),[t,m]=N.useState(!1),[l,a]=N.useState(null),d=(localStorage.getItem("temp_first_login_role")||"AGENT")==="ADMIN",{formHooks:w,formSubmit:b}=M({setLoading:c,setIsFirstLogin:m,setFirstLoginData:a}),{control:i}=w;return e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",style:{backgroundColor:"#efefef"},children:e.jsxs("div",{className:"w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx(G,{size:100,src:"https://t3.ftcdn.net/jpg/02/99/04/20/360_F_299042079_vGBD7wIlSeNl7vOevWHiL93G4koMM967.jpg",icon:e.jsx(B,{size:40})}),e.jsx("h1",{className:"text-3xl font-bold",style:{color:"#652d90"},children:t?`Set New Password - ${d?"Admin":"Agent"}`:"System Login"}),e.jsx("p",{className:"text-gray-600 mt-2",children:t?`Complete your ${d?"admin":"agent"} account setup`:"Consultancy Chatbot System"})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl p-8 border border-gray-100",children:[e.jsxs("form",{className:"space-y-6",onSubmit:u=>{u.preventDefault(),b(u)},children:[t?e.jsxs(e.Fragment,{children:[e.jsx(R,{message:`${d?"Admin":"Agent"} First Login Setup`,description:`Welcome! Please set a new password for ${l?.email} (${d?"Admin Account":"Agent Account"})`,type:"info",icon:e.jsx(U,{}),className:"mb-6"}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg mb-6",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-2",children:e.jsx("strong",{children:"Account Details:"})}),e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Email:"}),e.jsx("span",{className:"ml-2 font-medium",children:l?.email})]})]}),e.jsx(k,{className:"!my-6",children:"Set New Password"}),e.jsx(x,{control:i,name:"current_password",label:"Current Password",placeholder:"Enter the password provided to you"}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(x,{control:i,name:"new_password",label:"New Password",placeholder:"Enter your new password"}),e.jsx(x,{control:i,name:"confirm_password",label:"Confirm New Password",placeholder:"Confirm your new password"})]}),e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg",children:e.jsxs("div",{className:"text-xs text-blue-700",children:[e.jsx("strong",{children:"Password Requirements:"}),e.jsxs("ul",{className:"mt-2 space-y-1",children:[e.jsx("li",{children:"• At least 6 characters long"}),e.jsx("li",{children:"• Must contain letters and numbers"}),e.jsx("li",{children:"• Both passwords must match"})]})]})})]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{control:i,name:"email",label:"Email Address",placeholder:"Enter email address"}),e.jsx(x,{control:i,name:"password",label:"Password",placeholder:"Enter password"})]}),!t&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{id:"remember-me",name:"remember-me",type:"checkbox",className:"h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500"}),e.jsx("label",{htmlFor:"remember-me",className:"ml-2 block text-sm text-gray-700",children:"Remember me"})]}),e.jsx("button",{type:"button",className:"text-sm font-medium transition-colors duration-200 hover:opacity-80",style:{color:"#652d90"},children:"Forgot password?"})]}),e.jsx(j,{type:"primary",htmlType:"submit",className:"w-full !h-12 !text-base !font-semibold",loading:r,style:{backgroundColor:"#652d90",borderColor:"#652d90"},children:t?"Set New Password":"Sign In"}),t&&e.jsx("div",{className:"text-center mt-4",children:e.jsx(j,{type:"link",onClick:()=>{m(!1),a(null)},className:"text-sm",style:{color:"#652d90"},children:"Back to Login"})})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("p",{className:"text-sm text-gray-600",children:["Need access?"," ",e.jsx("button",{type:"button",className:"font-medium transition-colors duration-200 hover:opacity-80",style:{color:"#f7941d"},children:"Contact Administrator"})]})})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx("p",{className:"text-xs text-gray-500",children:"Secure login for authorized users only"})})]})})}export{J as default};
