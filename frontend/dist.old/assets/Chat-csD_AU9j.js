import{j as e,A,n as W,r as m,s as R}from"./index-Bl3f9Dxg.js";import{a as I}from"./index-DsVMNOFc.js";import{g as U,a as E}from"./get-BQpI_nQr.js";import{s as F}from"./post-D6em6Wc_.js";function H({userName:s="Bigyan",lastMessage:r="It is a long established fact",time:g="00",isSelected:d=!1,onClick:t}){const u=l=>l.split(" ").map(f=>f[0]).join("").toUpperCase().slice(0,2),i=(l,f=80)=>l.length<=f?l:l.substring(0,f)+"...";return e.jsxs("div",{className:`rounded-md p-4 flex gap-3 min-h-[120px] w-full cursor-pointer transition-colors ${d?"bg-blue-100 border-2 border-blue-300":"bg-gray-200 hover:bg-gray-300"}`,onClick:t,children:[e.jsx("div",{className:"flex-shrink-0 w-[35px] h-[35px]",children:e.jsx(A,{size:35,children:e.jsx("span",{className:"text-sm",children:u(s)})})}),e.jsxs("div",{className:"flex-1 min-w-0 space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("p",{className:"text-base font-medium text-gray-900 truncate",children:s}),e.jsx("span",{className:"text-xs text-gray-500 flex-shrink-0 ml-2",children:g})]}),e.jsx("div",{className:"text-sm text-gray-600",children:e.jsx("p",{className:"break-words line-clamp-3 leading-relaxed",children:i(r,100)})})]})]})}function P({message:s}){const r=s.message_type==="agent",g=s.message_type==="user",d=s.message_type==="bot",t=x=>new Date(x).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0}),u=x=>x?x.split(" ").map(c=>c[0]).join("").toUpperCase().slice(0,2):"U",i=()=>r?s.sender_name||"Agent":g?s.sender_name||"User":d?"SpellBot":"Unknown",l=()=>r?"#52c41a":g?"#1890ff":d?"#722ed1":"#d9d9d9",f=()=>r?"bg-green-500 text-white":g?"bg-white text-gray-900":d?"bg-purple-500 text-white":"bg-gray-200 text-gray-900";return e.jsxs("div",{className:`flex items-start gap-3 ${r?"justify-end":"justify-start"}`,children:[!r&&e.jsx(A,{size:32,style:{backgroundColor:l(),flexShrink:0},children:e.jsx("span",{className:"text-xs font-medium",children:u(i())})}),e.jsxs("div",{className:`flex flex-col ${r?"items-end":"items-start"} max-w-xs lg:max-w-md`,children:[e.jsxs("div",{className:`px-4 py-2 rounded-lg shadow ${f()}`,children:[s.file_url&&s.file_name&&e.jsx("div",{className:"mb-2",children:e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-black bg-opacity-10 rounded",children:[e.jsx("span",{className:"text-sm",children:"ðŸ“Ž"}),e.jsx("a",{href:s.file_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm underline hover:no-underline",children:s.file_name})]})}),e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:s.content})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("span",{className:"text-xs text-gray-500",children:i()}),e.jsx("span",{className:"text-xs text-gray-400",children:t(s.timestamp)})]})]}),r&&e.jsx(A,{size:32,style:{backgroundColor:l(),flexShrink:0},children:e.jsx("span",{className:"text-xs font-medium",children:u(i())})})]})}const O=(s,r={})=>{const{companyId:g}=W(),[d,t]=m.useState(!1),u=m.useRef(null),{onMessageReceived:i,onConnectionChange:l}=r;return m.useEffect(()=>{if(!s||!g)return;const x=`ws://localhost:8000/ws/chat/${g}/${s}/`,c=new WebSocket(x);return u.current=c,c.onopen=()=>{t(!0),l?.(!0),console.log(`Admin WebSocket connected for session ${s}`)},c.onmessage=b=>{try{const n=JSON.parse(b.data);switch(console.log("Admin WebSocket message received:",n),n.type){case"chat_message":n.sender_type==="user"&&i?(console.log("Processing user message from WebSocket:",n.message),i({id:n.message_id,content:n.message,message_type:n.sender_type,timestamp:n.timestamp,sender_name:n.sender_name,file_url:n.file_url,file_name:n.file_name,file_type:n.file_type})):n.sender_type==="agent"&&console.log("Ignoring agent message from WebSocket to prevent duplicates");break;case"agent_joined":console.log("Agent joined the session:",n.agent_info);break;case"typing":console.log("Typing indicator:",n);break;case"connection_established":console.log("WebSocket connection established:",n.message);break;default:console.log("Unknown WebSocket message type:",n.type)}}catch(n){console.error("Error parsing WebSocket message:",n)}},c.onclose=()=>{t(!1),l?.(!1),console.log("Admin WebSocket disconnected")},c.onerror=b=>{console.error("Admin WebSocket error:",b),t(!1),l?.(!1)},()=>{c.readyState===WebSocket.OPEN&&c.close()}},[s,g,i,l]),{isConnected:d,sendWebSocketMessage:(x,c="Admin")=>{u.current&&u.current.readyState===WebSocket.OPEN&&u.current.send(JSON.stringify({type:"chat_message",message:x,sender_type:"agent",sender_name:c,session_id:s}))}}},M=(s,r)=>s.id&&r.id&&s.id===r.id?!0:s.content===r.content&&s.message_type===r.message_type&&Math.abs(new Date(s.timestamp).getTime()-new Date(r.timestamp).getTime())<2e3,L=()=>{const{companyId:s}=W(),[r,g]=m.useState([]),[d,t]=m.useState(null),[u,i]=m.useState([]),[l,f]=m.useState(!1),[x,c]=m.useState(!1),[b,n]=m.useState(!1),[h,S]=R.useMessage(),{isConnected:_}=O(d?.session_id||null,{onMessageReceived:o=>{o.message_type==="user"&&i(p=>p.some(w=>M(w,o))?p:[...p,o])},onConnectionChange:o=>{console.log("Admin WebSocket connection:",o?"Connected":"Disconnected")}}),N=m.useCallback(async()=>{try{f(!0);const o=await U();g(o.data||[])}catch(o){console.error("Failed to load handoff sessions:",o),h.error("Failed to load sessions")}finally{f(!1)}},[h]),j=m.useCallback(async o=>{if(!s){console.warn("No company ID available for loading messages"),h.error("Company ID not available");return}try{c(!0);const w=((await E(o,s)).data.messages||[]).filter((v,$,C)=>C.findIndex(T=>M(T,v))===$);i(w)}catch(p){console.error("Failed to load messages:",p),h.error("Failed to load messages")}finally{c(!1)}},[s,h]),a=m.useCallback(async(o,p)=>{try{n(!0);const y=await F({session_id:o,message:p});if(y.data.chat_message){const w={...y.data.chat_message,message_type:"agent",sender_name:"Admin"};i(v=>v.some(C=>M(C,w))?v:[...v,w])}return h.success("Message sent successfully"),y.data}catch(y){throw console.error("Failed to send message:",y),h.error("Failed to send message"),y}finally{n(!1)}},[h]),k=m.useCallback(async o=>{i([]),t(o),await j(o.session_id)},[j]),D=m.useCallback(()=>{d&&(i([]),j(d.session_id))},[d,j]);return m.useEffect(()=>{N()},[N]),{handoffSessions:r,selectedSession:d,messages:u,loading:l,loadingMessages:x,sendingMessage:b,isConnected:_,sendMessage:a,selectSession:k,loadHandoffSessions:N,loadSessionMessages:j,refreshMessages:D,contextHolder:S}};function Y(){const[s,r]=m.useState(""),{companyId:g}=W(),{handoffSessions:d,selectedSession:t,messages:u,loading:i,loadingMessages:l,sendingMessage:f,isConnected:x,sendMessage:c,selectSession:b,loadHandoffSessions:n,refreshMessages:h,contextHolder:S}=L(),_=a=>{const k=new Date(a),o=new Date().getTime()-k.getTime(),p=Math.floor(o/(1e3*60));return p<60?`${p}m`:`${Math.floor(p/60)}h`},N=async()=>{if(!(!s.trim()||!t))try{await c(t.session_id,s.trim()),r("")}catch(a){console.error("Failed to send message:",a)}},j=a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),N())};return e.jsxs("div",{className:"pt-4 space-y-4",children:[S,e.jsx("div",{className:"bg-white rounded-lg p-4 shadow-sm border",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:"Admin Chat Dashboard"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Direct chat with escalated users â€¢ Company: ",g]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm font-medium text-purple-600",children:"Admin Mode"}),e.jsx("p",{className:"text-xs text-gray-500",children:"You can chat directly with users"}),t&&e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${x?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs text-gray-500",children:x?"Real-time connected":"Offline"})]})]}),e.jsx("button",{onClick:n,disabled:i,className:"bg-purple text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 disabled:opacity-50",children:i?"Loading...":"Refresh"})]})]})}),e.jsxs("div",{className:"flex gap-4 h-[600px]",children:[e.jsx("div",{className:"basis-[25%] space-y-2 border-r pr-2 overflow-y-auto",children:i?e.jsx("div",{className:"text-center py-4",children:"Loading sessions..."}):d.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500",children:[e.jsx("p",{children:"No pending sessions"}),e.jsx("p",{className:"text-sm",children:"When your company's chatbot users escalate to human, they will appear here"}),e.jsxs("p",{className:"text-xs mt-1",children:["Company: ",g]})]}):d.map(a=>e.jsx(H,{userName:a.user_name,lastMessage:a.message,time:_(a.created_at),isSelected:t?.id===a.id,onClick:()=>b(a)},a.id))}),e.jsxs("div",{className:"flex flex-col flex-1 bg-gray-50 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between pb-2",children:[e.jsx("div",{className:"font-bold",children:t?`Chat with ${t.user_name}`:"Select a session to start chatting"}),t&&e.jsx("button",{onClick:h,className:"text-sm text-purple-600 hover:text-purple-800 px-2 py-1 rounded",title:"Refresh messages",children:"ðŸ”„ Refresh"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto space-y-4 mt-3 p-4",children:l?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto"}),e.jsx("p",{className:"text-gray-500 mt-2",children:"Loading messages..."})]}):u.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ’¬"}),e.jsx("p",{className:"text-lg font-medium",children:t?"No messages yet":"Select a session to view messages"}),e.jsx("p",{className:"text-sm mt-1",children:t?"Start the conversation with your user!":"Choose a pending session from the left panel"})]}):u.map(a=>e.jsx(P,{message:a},a.id))}),e.jsxs("div",{className:"bg-white border-t p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"file",style:{display:"none"},onChange:a=>{console.log("file",a.target.files?.[0])},id:"upload-file"}),e.jsx("label",{htmlFor:"upload-file",className:"cursor-pointer text-gray-400 hover:text-purple-600 transition-colors",children:e.jsx(I,{size:28})}),e.jsx("div",{className:"flex-1 relative",children:e.jsx("input",{type:"text",placeholder:t?"Type your message...":"Select a session to start chatting",className:"w-full px-4 py-3 border border-gray-300 rounded-full outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent disabled:bg-gray-100 disabled:text-gray-500",value:s,onChange:a=>r(a.target.value),onKeyDown:j,disabled:!t||f})}),e.jsx("button",{className:"bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-full font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed min-w-[80px]",onClick:N,disabled:!t||!s.trim()||f,children:f?e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"})}):"Send"})]}),t&&e.jsxs("div",{className:"flex items-center justify-between mt-3 text-xs text-gray-500",children:[e.jsxs("span",{children:["ðŸ’¬ Chatting with ",t.user_name]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${x?"bg-green-500":"bg-gray-400"}`}),e.jsx("span",{children:x?"Real-time connected":"Offline"})]})]})]})]})]})]})}export{Y as default};
