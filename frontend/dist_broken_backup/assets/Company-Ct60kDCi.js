import{j as e,D as ae,l as se,m as te,u as w,f as V,r as j,B as E,b as ne,a as M}from"./index-B1s0lSLI.js";import{F as re}from"./index-qADxWjA3.js";import{A as le}from"./AppTable-B4cfyg42.js";import{B as oe,R as ce,A as ie}from"./index-CYExsLr9.js";import{a as de,d as pe,A as x}from"./AppInput-CTSF17_b.js";import{u as me}from"./index.esm-BvqbcHXe.js";import{a as ue}from"./post-HmTe7iSH.js";import{e as he,d as be}from"./delete-BDajKvPh.js";import{A as xe}from"./AppSelect-DxTf8CtI.js";import{A as fe}from"./AppPassword-R-P3nPbt.js";import{M as D}from"./index-Bww_55Jg.js";import{b as ye}from"./get-CePa9ADr.js";import{F as g}from"./index-IboHRLlQ.js";import{I as O}from"./index-DeUN4VAv.js";import{S as I}from"./index-nbjyTpMb.js";import"./Table-lnND1gKm.js";import"./index-DS3szUx1.js";import"./TextArea-Cg92ZfrA.js";import"./SearchOutlined-sMDHwJuX.js";import"./index-CRG7af4g.js";import"./DeleteOutlined-Bp9tC0kG.js";import"./CheckOutlined-BPgsch0U.js";const je=({handleOpenViewCompanyModal:n,handleDeleteOpenModal:u,handleCancelSubscription:h,handleReactivateSubscription:c,handleResetPassword:p})=>{const l=a=>[{label:"View",key:"1",icon:e.jsx(se,{size:17}),onClick:()=>{n(a?.id)}},{label:"Reset Password",key:"2",icon:e.jsx(ce,{size:17}),onClick:()=>{p(a?.id,a?.email)}},{label:"Delete Company",key:"3",icon:e.jsx(te,{size:17}),danger:!0,onClick:()=>{u(a?.name,a?.id)}}];return{columns:[{title:"Sn",render:({sn:a})=>e.jsx("p",{children:a})},{title:"Name",render:({name:a})=>e.jsx("p",{children:a})},{title:"Contact Person",render:({contact_person:a})=>e.jsx("p",{children:a})},{title:"Contact Number",render:({contact_number:a})=>e.jsx("p",{children:a})},{title:"Phone Number",render:({phone_number:a})=>e.jsx("p",{children:a})},{title:"email",render:({email:a})=>e.jsx("p",{children:a})},{title:"Address",render:({address:a})=>e.jsx("p",{children:a})},{align:"right",title:"Action",width:100,render:a=>e.jsx("div",{className:"float-right",children:e.jsx(ae,{menu:{items:l(a)},trigger:["click"],children:e.jsx(oe,{className:"cursor-pointer"})})})}]}},ge=({setLoading:n,handleCloseModal:u,mutate:h,companyId:c})=>{const{data:p}=w(c?`/auth/list-admins/?admin_id=${c}`:""),{messageApi:l}=V(),i=me({resolver:de(pe),mode:"onChange",defaultValues:{name:"",contact_person:"",email:"",address:"",contact_number:"",phone_number:"",plan_id:"",expiry_date:"",custom_max_agents:void 0,custom_price:void 0}}),{handleSubmit:a,reset:f}=i,y=r=>{n(!0),c?he(r,c).then(()=>{l.success("Update Company Successfully"),n(!1),u(),h()}).catch(o=>{l.error(o?.message),n(!1)}):ue(r).then(()=>{l.success("Company Create Successfully"),n(!1),u(),h()}).catch(o=>{l.error(o?.message),n(!1)})};return j.useEffect(()=>{f({...p,plan_id:p?.current_plan?.plan_id})},[c,p,f]),{formHooks:i,formSubmit:a(y)}};function Ce({isModalOpen:n,onCancel:u,setLoading:h,loading:c,mutate:p,companyId:l}){const i=()=>{u(),C()},{data:a,error:f}=w("/auth/plan-types/");console.log("planTypesData:",a),console.log("planTypesError:",f);const y=Array.isArray(a)?a.map(S=>({label:S.label,value:S.value})):[],{formSubmit:r,formHooks:o}=ge({setLoading:h,handleCloseModal:i,mutate:p,companyId:l}),{control:t,reset:C,watch:m}=o,_=m("plan_id")==="custom";return e.jsx(D,{width:700,className:"",title:l?"Edit Company":"Add Company",footer:()=>e.jsxs("div",{className:"flex gap-2 items-center justify-end",children:[e.jsx(E,{type:"text",onClick:i,children:"Cancel"}),e.jsx(E,{type:"primary",htmlType:"submit",form:"add-company",loading:c,children:"Save"})]}),open:n,onCancel:i,centered:!0,children:e.jsxs("form",{onSubmit:r,className:"grid grid-cols-1 md:grid-cols-2 gap-3",id:"add-company",children:[e.jsx(x,{control:t,name:"name",label:"Name",placeholder:"Enter name"}),e.jsx(x,{control:t,name:"email",label:"Email",placeholder:"Enter email"}),e.jsx(x,{control:t,name:"address",label:"Address",placeholder:"Enter address"}),e.jsx(x,{control:t,name:"contact_person",label:"Contact Person",placeholder:"Enter contact person"}),e.jsx(x,{control:t,name:"contact_number",label:"Contact number",placeholder:"Enter contact number"}),e.jsx(x,{control:t,name:"phone_number",label:"Phone Number",placeholder:"Enter phone number"}),e.jsx(xe,{control:t,name:"plan_id",label:"Plan",placeholder:"Select Plan",options:y}),e.jsx(x,{control:t,name:"expiry_date",label:"Expiry Date",placeholder:"YYYY-MM-DD",type:"date"}),_&&e.jsxs(e.Fragment,{children:[e.jsx(x,{control:t,name:"custom_max_agents",label:"Max Agents",placeholder:"Enter max agents",type:"number"}),e.jsx(x,{control:t,name:"custom_price",label:"Price",placeholder:"Enter price",type:"number"})]}),l&&e.jsx(fe,{control:t,name:"generated_password",label:"Generated Password",placeholder:"Enter password"})]})})}function Le(){const{messageApi:n}=V(),[u,h]=j.useState(!1),[c,p]=j.useState(!1),[l,i]=j.useState(!1),[a,f]=j.useState(!1),[y,r]=j.useState(!1),[o,t]=j.useState(null),[C,m]=j.useState(""),[N,_]=ne({}),S=Number(N.get("page"))||1,[b]=g.useForm(),$=()=>{console.log("Closing modal"),h(!1),t(null)},R=()=>{p(!1),m(""),t(null)},B=(s,d)=>{p(!0),m(s),t(d)},z=(s,d)=>{i(!0),m(s),t(d)},Y=(s,d)=>{f(!0),m(s),t(d)},H=()=>{r(!0),be(o).then(()=>{n.success("Delete Company Successfully"),R(),v(),r(!1)}).catch(s=>{n.error(s?.message),r(!1)})},L=async()=>{if(o){r(!0);try{const s=b.getFieldValue("reason")||"Subscription cancelled by admin";await M.post(`/auth/cancel-subscription/${o}/`,{reason:s}),n.success("Subscription cancelled successfully"),i(!1),m(""),t(null),b.resetFields(),v()}catch(s){n.error(s?.response?.data?.error||"Failed to cancel subscription")}finally{r(!1)}}},q=async()=>{if(o){r(!0);try{const s=b.getFieldValue("plan_id"),d=b.getFieldValue("reason")||"Subscription reactivated by admin";if(!s){n.error("Please select a plan"),r(!1);return}await M.post(`/auth/reactivate-subscription/${o}/`,{plan_id:s,reason:d}),n.success("Subscription reactivated successfully"),f(!1),m(""),t(null),b.resetFields(),v()}catch(s){n.error(s?.response?.data?.error||"Failed to reactivate subscription")}finally{r(!1)}}},G=()=>{console.log("Add Company button clicked"),h(!0),t(null),console.log("Modal state set to true, companyId set to null")},K=s=>{h(!0),t(s)},U=s=>{_({page:s.toString()})},W=async(s,d)=>{try{const P=await M.post("/auth/reset-admin-password/",{admin_id:s}),{new_password:A}=P.data;n.success(`Password reset successfully!
        Email: ${d}
        New Password: ${A}
        Admin must use this password for first login.`),v()}catch(P){const A=P;n.error(A?.response?.data?.error||A?.message||"Failed to reset password")}},{columns:J}=je({handleOpenViewCompanyModal:K,handleDeleteOpenModal:B,handleCancelSubscription:z,handleReactivateSubscription:Y,handleResetPassword:W}),{data:F,isLoading:Q,mutate:v}=w(`/auth/list-admins/?page=${S}`),{data:X,error:T}=w("/auth/plan-types/",ye),k=X?.data||[];T&&console.error("Error loading plan types:",T);const Z=F?.results.map((s,d)=>({sn:d+1,...s})),ee=F?.count;return e.jsxs("div",{className:"pt-4 space-y-5",children:[e.jsx("h2",{className:"font-bold text-2xl",children:"Company"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("h6",{className:"font-bold text-xl",children:"Company List"}),e.jsx(E,{type:"primary",icon:e.jsx(re,{size:15}),onClick:G,children:"Add"})]}),e.jsx(le,{total:ee,paginationData:S,handlePagination:U,columns:J,dataSource:Z,loading:Q,rowKey:"id"}),u&&e.jsx(Ce,{companyId:o,mutate:v,isModalOpen:u,onCancel:$,loading:y,setLoading:r}),c&&e.jsx(ie,{loading:y,name:C,isDeleteOpenModal:c,handleCancel:R,onDelete:H}),e.jsx(D,{title:"Cancel Subscription",open:l,onOk:L,onCancel:()=>{i(!1),m(""),t(null),b.resetFields()},confirmLoading:y,okText:"Cancel Subscription",okButtonProps:{danger:!0},children:e.jsxs(g,{form:b,layout:"vertical",children:[e.jsxs("p",{children:["Are you sure you want to cancel the subscription for ",e.jsx("strong",{children:C}),"?"]}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"This will disable the chatbot widget but preserve all company data. The subscription can be reactivated later."}),e.jsx(g.Item,{name:"reason",label:"Reason for cancellation (optional)",children:e.jsx(O.TextArea,{rows:3,placeholder:"Enter reason for cancelling subscription..."})})]})}),e.jsx(D,{title:"Reactivate Subscription",open:a,onOk:q,onCancel:()=>{f(!1),m(""),t(null),b.resetFields()},confirmLoading:y,okText:"Reactivate Subscription",children:e.jsxs(g,{form:b,layout:"vertical",children:[e.jsxs("p",{children:["Reactivate subscription for ",e.jsx("strong",{children:C})]}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Select a plan to reactivate the subscription and enable the chatbot widget."}),e.jsx(g.Item,{name:"plan_id",label:"Select Plan",rules:[{required:!0,message:"Please select a plan"}],children:e.jsx(I,{placeholder:"Choose a plan",children:Array.isArray(k)&&k.map(s=>e.jsx(I.Option,{value:s.value,children:s.label},s.value))})}),e.jsx(g.Item,{name:"reason",label:"Reason for reactivation (optional)",children:e.jsx(O.TextArea,{rows:3,placeholder:"Enter reason for reactivating subscription..."})})]})})]})]})}export{Le as default};
